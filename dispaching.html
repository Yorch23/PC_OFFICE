<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dispatch Protecci√≥n Civil (Offline)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jsPDF y AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { padding: 20px; }
    /* Colores por estado INDICATIVO - FILA COMPLETA */
    .estado-LIBRE td { background-color: #d4edda !important; }
    .estado-EN_CAMINO td { background-color: #fff3cd !important; }
    .estado-EN_AVISO td { background-color: #f8d7da !important; }
    .estado-RETORNO_BASE td { background-color: #cce5ff !important; }
    .estado-LIBRE_BASE td { background-color: #e2e3e5 !important; }
    
    /* Colores avisos */
    .aviso-pendiente { background-color: #fff3cd; }
    .aviso-en_curso { background-color: #f8d7da; }
    .aviso-finalizado { background-color: #d4edda; }
    
    textarea, input { resize: vertical; }
    .aviso-item { margin-bottom: 4px; cursor: pointer; }
    .editando { border: 2px solid #0d6efd !important; box-shadow: 0 0 5px #0d6efd; }
    .tiempos { font-size: 0.8em; color: #666; }
    /* Asegurar que los inputs sean editables */
    input.form-control, textarea.form-control, select.form-select {
      pointer-events: auto !important;
      background-color: white !important;
      opacity: 1 !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">Dispatch Protecci√≥n Civil (Offline)</h1>

    <!-- Alta indicativos -->
    <div class="card mb-3">
      <div class="card-header">Alta indicativos</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-8">
            <label for="indicativo" class="form-label">Indicativo</label>
            <input type="text" id="indicativo" class="form-control" placeholder="Ej: PC-01">
          </div>
          <div class="col-md-4">
            <button id="btnAgregarIndicativo" class="btn btn-primary w-100">A√±adir activo</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Gesti√≥n Avisos -->
    <div class="card mb-3">
      <div class="card-header">Gesti√≥n Avisos</div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-3">
            <label class="form-label">Indicativo</label>
            <select id="selectIndicativoAviso" class="form-select">
              <option value="">-- Selecciona --</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="descripcionAviso" class="form-label">Descripci√≥n</label>
            <input type="text" id="descripcionAviso" class="form-control" placeholder="Servicio...">
          </div>
          <div class="col-md-3">
            <label for="resultadoAviso" class="form-label">Resultado</label>
            <input type="text" id="resultadoAviso" class="form-control" placeholder="Resultado...">
          </div>
          <div class="col-md-3">
            <button id="btnA√±adirAviso" class="btn btn-warning w-100 mt-4">Nuevo Aviso</button>
          </div>
        </div>
        <div class="row g-2 mt-2">
          <div class="col-md-2">
            <button id="btnEnCamino" class="btn btn-info w-100">‚Üí En Camino</button>
          </div>
          <div class="col-md-2">
            <button id="btnEnAviso" class="btn btn-danger w-100">‚Üí En Aviso</button>
          </div>
          <div class="col-md-2">
            <button id="btnRetornoBase" class="btn btn-info w-100">‚Üí Retorno Base</button>
          </div>
          <div class="col-md-2">
            <button id="btnLibreBase" class="btn btn-success w-100">‚Üí Libre Base</button>
          </div>
          <div class="col-md-2">
            <button id="btnAvisoEnCurso" class="btn btn-primary w-100">Aviso Curso</button>
          </div>
          <div class="col-md-2">
            <button id="btnAvisoFinalizado" class="btn btn-success w-100">Aviso Finalizado</button>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col-md-6">
            <button id="btnGenerarPDF" class="btn btn-success">üìÑ PDF Completo</button>
          </div>
          <div class="col-md-6">
            <button id="btnBorrarTodo" class="btn btn-danger">üóëÔ∏è Borrar Todo</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card">
      <div class="card-header">Indicativos Activos</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-bordered mb-0" id="tablaIndicativos">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Indicativo</th>
                <th>Estado (coloreado)</th>
                <th>Avisos (click para editar)</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const tablaBody = document.querySelector('#tablaIndicativos tbody');
    const inputIndicativo = document.getElementById('indicativo');
    const selectIndicativoAviso = document.getElementById('selectIndicativoAviso');
    const descripcionAviso = document.getElementById('descripcionAviso');
    const resultadoAviso = document.getElementById('resultadoAviso');

    let indicativos = [];
    let contador = 1;
    let indicativoSeleccionado = null;
    let avisoEditando = null;

    function getHoraActual() {
      return new Date().toLocaleString('es-ES', { 
        timeZone: 'Europe/Madrid',
        hour: '2-digit', minute: '2-digit', second: '2-digit'
      });
    }

    function actualizarSelect() {
      selectIndicativoAviso.innerHTML = '<option value="">-- Selecciona --</option>';
      indicativos.forEach(ind => {
        const opt = document.createElement('option');
        opt.value = ind.id;
        opt.textContent = ind.indicativo;
        selectIndicativoAviso.appendChild(opt);
      });
    }

    function crearFila(ind) {
      const tr = document.createElement('tr');
      tr.dataset.id = ind.id;
      tr.className = `estado-${ind.estado.replace(/ /g, '_')}`;

      let avisosHtml = '';
      if (ind.avisos && ind.avisos.length) {
        avisosHtml = ind.avisos.map((aviso, idx) => {
          const tiempos = [];
          if (aviso.horaAsignado) tiempos.push(`Asig:${aviso.horaAsignado}`);
          if (aviso.horaEnCamino) tiempos.push(`Camino:${aviso.horaEnCamino}`);
          if (aviso.horaFinalizado) tiempos.push(`Fin:${aviso.horaFinalizado}`);
          
          return `<div class="aviso-item p-2 mb-1 rounded aviso-${aviso.estado.toLowerCase().replace(/_/g, '-')}" onclick="editarAviso(${ind.id}, ${idx})">
            <div><strong>${aviso.descripcion}</strong></div>
            <div>${aviso.resultado || ''}</div>
            <div class="tiempos">${tiempos.join(' | ')} | ${aviso.estado}</div>
          </div>`;
        }).join('');
      } else {
        avisosHtml = '<em class="text-muted">Sin avisos</em>';
      }

      tr.innerHTML = `
        <td>${ind.id}</td>
        <td><h6 class="mb-0">${ind.indicativo}</h6></td>
        <td>
          <select class="form-select form-select-sm estado-ind">
            <option value="LIBRE">LIBRE</option>
            <option value="EN_CAMINO">EN CAMINO</option>
            <option value="EN_AVISO">EN AVISO</option>
            <option value="RETORNO_BASE">RETORNO BASE</option>
            <option value="LIBRE_BASE">LIBRE BASE</option>
          </select>
        </td>
        <td style="vertical-align: top;">${avisosHtml}</td>
        <td>
          <div class="btn-group-vertical btn-group-sm">
            <button class="btn btn-warning btn-nuevo-aviso">+Aviso</button>
            <button class="btn btn-info btn-encamino">En Camino</button>
            <button class="btn btn-danger btn-enaviso">En Aviso</button>
            <button class="btn btn-primary btn-retbase">Retorno</button>
            <button class="btn btn-success btn-libase">Libre Base</button>
          </div>
        </td>
      `;

      // Estado actual
      const selectEstado = tr.querySelector('.estado-ind');
      selectEstado.value = ind.estado;
      selectEstado.addEventListener('change', (e) => {
        ind.estado = e.target.value;
        tr.className = `estado-${ind.estado.replace(/ /g, '_')}`;
      });

      // Botones indicativo
      tr.querySelector('.btn-nuevo-aviso').onclick = (e) => {
        e.stopPropagation();
        seleccionarIndicativo(ind.id);
      };
      tr.querySelector('.btn-encamino').onclick = (e) => {
        e.stopPropagation();
        cambiarEstadoIndicativo(ind.id, 'EN_CAMINO');
      };
      tr.querySelector('.btn-enaviso').onclick = (e) => {
        e.stopPropagation();
        cambiarEstadoIndicativo(ind.id, 'EN_AVISO');
      };
      tr.querySelector('.btn-retbase').onclick = (e) => {
        e.stopPropagation();
        cambiarEstadoIndicativo(ind.id, 'RETORNO_BASE');
      };
      tr.querySelector('.btn-libase').onclick = (e) => {
        e.stopPropagation();
        cambiarEstadoIndicativo(ind.id, 'LIBRE_BASE');
      };

      return tr;
    }

    function actualizarTabla() {
      tablaBody.innerHTML = '';
      indicativos.forEach(ind => {
        tablaBody.appendChild(crearFila(ind));
      });
      actualizarSelect();
    }

    // Hacer que editarAviso sea global para que funcione desde el onclick
    window.editarAviso = function(indId, avisoIdx) {
      const ind = indicativos.find(i => i.id === indId);
      if (!ind || !ind.avisos) return;
      
      const aviso = ind.avisos[avisoIdx];
      indicativoSeleccionado = ind;
      avisoEditando = aviso;
      
      selectIndicativoAviso.value = indId;
      descripcionAviso.value = aviso.descripcion;
      resultadoAviso.value = aviso.resultado || '';
      document.getElementById('btnA√±adirAviso').textContent = 'Guardar Cambios';
      
      // Hacer foco en la descripci√≥n para editar
      descripcionAviso.focus();
      descripcionAviso.parentElement.classList.add('editando');
    };

    function seleccionarIndicativo(id) {
      indicativoSeleccionado = indicativos.find(i => i.id === id);
      if (!indicativoSeleccionado) return;
      
      selectIndicativoAviso.value = id;
      descripcionAviso.value = '';
      resultadoAviso.value = '';
      avisoEditando = null;
      document.getElementById('btnA√±adirAviso').textContent = 'Nuevo Aviso';
      descripcionAviso.focus();
    }

    function anadirOEditarAviso() {
      if (!indicativoSeleccionado) {
        alert('Debes seleccionar un indicativo primero');
        return;
      }
      
      if (!descripcionAviso.value.trim()) {
        alert('¬°Descripci√≥n requerida!');
        return;
      }

      if (avisoEditando) {
        // Editar
        avisoEditando.descripcion = descripcionAviso.value.trim();
        avisoEditando.resultado = resultadoAviso.value.trim();
      } else {
        // Nuevo
        const nuevoAviso = {
          id: Date.now(),
          descripcion: descripcionAviso.value.trim(),
          resultado: resultadoAviso.value.trim(),
          estado: 'PENDIENTE',
          fecha: getHoraActual(),
          horaAsignado: getHoraActual(),
          horaEnCamino: null,
          horaFinalizado: null
        };
        if (!indicativoSeleccionado.avisos) {
          indicativoSeleccionado.avisos = [];
        }
        indicativoSeleccionado.avisos.push(nuevoAviso);
      }

      actualizarTabla();
      resetForm();
    }

    function resetForm() {
      descripcionAviso.value = '';
      resultadoAviso.value = '';
      selectIndicativoAviso.value = '';
      indicativoSeleccionado = null;
      avisoEditando = null;
      document.getElementById('btnA√±adirAviso').textContent = 'Nuevo Aviso';
      document.querySelectorAll('.editando').forEach(el => el.classList.remove('editando'));
    }

    function cambiarEstadoIndicativo(indId, estado) {
      const ind = indicativos.find(i => i.id === indId);
      if (!ind) return;
      
      ind.estado = estado;
      if (ind.avisos && ind.avisos.length) {
        const ultAviso = ind.avisos[ind.avisos.length - 1];
        if (estado === 'EN_CAMINO' && !ultAviso.horaEnCamino) {
          ultAviso.horaEnCamino = getHoraActual();
        } else if (estado === 'LIBRE_BASE' && !ultAviso.horaFinalizado) {
          ultAviso.horaFinalizado = getHoraActual();
          ultAviso.estado = 'FINALIZADO';
        }
      }
      actualizarTabla();
    }

    function borrarTodo() {
      if (confirm('¬øEst√°s seguro de que quieres borrar TODOS los indicativos y avisos? Esta acci√≥n no se puede deshacer.')) {
        indicativos = [];
        contador = 1;
        resetForm();
        actualizarTabla();
      }
    }

    // Eventos
    document.getElementById('btnAgregarIndicativo').onclick = () => {
      const indic = inputIndicativo.value.trim().toUpperCase();
      if (!indic) {
        alert('Por favor, escribe un indicativo');
        return;
      }
      if (indicativos.find(i => i.indicativo === indic)) {
        alert('Ese indicativo ya existe');
        return;
      }
      indicativos.push({
        id: contador++,
        indicativo: indic,
        estado: 'LIBRE',
        avisos: []
      });
      actualizarTabla();
      inputIndicativo.value = '';
      inputIndicativo.focus();
    };

    document.getElementById('btnA√±adirAviso').onclick = anadirOEditarAviso;
    
    document.getElementById('btnEnCamino').onclick = () => {
      if (indicativoSeleccionado) cambiarEstadoIndicativo(indicativoSeleccionado.id, 'EN_CAMINO');
      else alert('Selecciona un indicativo primero');
    };
    
    document.getElementById('btnEnAviso').onclick = () => {
      if (indicativoSeleccionado) cambiarEstadoIndicativo(indicativoSeleccionado.id, 'EN_AVISO');
      else alert('Selecciona un indicativo primero');
    };
    
    document.getElementById('btnRetornoBase').onclick = () => {
      if (indicativoSeleccionado) cambiarEstadoIndicativo(indicativoSeleccionado.id, 'RETORNO_BASE');
      else alert('Selecciona un indicativo primero');
    };
    
    document.getElementById('btnLibreBase').onclick = () => {
      if (indicativoSeleccionado) cambiarEstadoIndicativo(indicativoSeleccionado.id, 'LIBRE_BASE');
      else alert('Selecciona un indicativo primero');
    };

    document.getElementById('btnAvisoEnCurso').onclick = () => {
      if (!indicativoSeleccionado) {
        alert('Selecciona un indicativo primero');
        return;
      }
      if (indicativoSeleccionado?.avisos?.length) {
        const ult = indicativoSeleccionado.avisos[indicativoSeleccionado.avisos.length - 1];
        ult.estado = 'EN_CURSO';
        actualizarTabla();
      } else {
        alert('No hay avisos para este indicativo');
      }
    };

    document.getElementById('btnAvisoFinalizado').onclick = () => {
      if (!indicativoSeleccionado) {
        alert('Selecciona un indicativo primero');
        return;
      }
      if (indicativoSeleccionado?.avisos?.length) {
        const ult = indicativoSeleccionado.avisos[indicativoSeleccionado.avisos.length - 1];
        ult.estado = 'FINALIZADO';
        ult.horaFinalizado = getHoraActual();
        actualizarTabla();
      } else {
        alert('No hay avisos para este indicativo');
      }
    };

    document.getElementById('btnBorrarTodo').onclick = borrarTodo;

    selectIndicativoAviso.onchange = (e) => {
      if (e.target.value) {
        seleccionarIndicativo(parseInt(e.target.value));
      } else {
        resetForm();
      }
    };

    // PDF detallado con tiempos
    document.getElementById('btnGenerarPDF').onclick = () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      doc.setFontSize(16);
      doc.text('PARTE COMPLETO AVISOS PC', 105, 20, { align: 'center' });
      doc.text(`Fecha: ${new Date().toLocaleString('es-ES')}`, 105, 30, { align: 'center' });

      const datos = [];
      indicativos.forEach(ind => {
        if (ind.avisos && ind.avisos.length > 0) {
          datos.push([{ content: `${ind.indicativo} (${ind.estado})`, colSpan: 5, styles: { fillColor: [200, 200, 200], bold: true } }]);
          ind.avisos.forEach(aviso => {
            datos.push([
              aviso.descripcion,
              aviso.resultado || '',
              aviso.estado,
              aviso.horaAsignado || '',
              `${aviso.horaEnCamino || ''} / ${aviso.horaFinalizado || ''}`
            ]);
          });
        }
      });

      if (datos.length > 0) {
        doc.autoTable({
          head: [['Descripci√≥n', 'Resultado', 'Estado', 'Hora Asignado', 'Camino/Fin']],
          body: datos,
          startY: 40,
          theme: 'grid',
          styles: { fontSize: 7 }
        });
      } else {
        doc.text('No hay avisos para mostrar', 105, 40, { align: 'center' });
      }

      doc.save(`parte_pc_${Date.now()}.pdf`);
    };

    // Enter
    inputIndicativo.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btnAgregarIndicativo').click();
      }
    });
    
    descripcionAviso.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('btnA√±adirAviso').click();
      }
    });

    // Inicializar sin ejemplos
    window.onload = function() {
      actualizarTabla();
    };
  </script>
</body>
</html>